<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TerminalSync</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #1a1a2e; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace; height: 100vh; display: flex; flex-direction: column; }

    #toolbar { display: flex; align-items: center; gap: 12px; padding: 8px 16px; background: #16213e; border-bottom: 1px solid #0f3460; flex-shrink: 0; }
    #toolbar h1 { font-size: 14px; font-weight: 600; color: #e94560; margin-right: 8px; }
    #toolbar button { background: #0f3460; color: #e0e0e0; border: 1px solid #533483; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    #toolbar button:hover { background: #533483; }
    #toolbar button.active { background: #e94560; border-color: #e94560; }
    #toolbar .spacer { flex: 1; }
    #toolbar #status { font-size: 11px; color: #888; }
    #token-input { background: #0a0a1a; color: #e0e0e0; border: 1px solid #533483; padding: 4px 8px; border-radius: 4px; font-size: 12px; width: 160px; }

    #session-bar { display: flex; gap: 4px; padding: 6px 16px; background: #0f3460; border-bottom: 1px solid #533483; flex-shrink: 0; overflow-x: auto; min-height: 36px; align-items: center; }
    .session-tab { background: #16213e; color: #aaa; border: 1px solid #333; padding: 3px 10px; border-radius: 3px; cursor: pointer; font-size: 11px; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
    .session-tab:hover { border-color: #e94560; color: #e0e0e0; }
    .session-tab.attached { background: #e94560; color: #fff; border-color: #e94560; }
    .session-tab .dot { width: 6px; height: 6px; border-radius: 50%; background: #4caf50; display: inline-block; }
    .session-tab .dot.exited { background: #666; }
    #no-sessions { font-size: 11px; color: #555; }

    #terminal-container { flex: 1; position: relative; overflow: hidden; }
    #terminal-container .xterm { height: 100%; padding: 4px; }

    #splash { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 12px; color: #555; font-size: 14px; }
  </style>
</head>
<body>
  <div id="toolbar">
    <h1>TerminalSync</h1>
    <input id="token-input" type="password" placeholder="Token" />
    <button id="btn-connect">Connect</button>
    <div class="spacer"></div>
    <span id="status">disconnected</span>
  </div>
  <div id="session-bar">
    <span id="no-sessions">Connect to see sessions</span>
  </div>
  <div id="terminal-container">
    <div id="splash">No session attached. Connect and click a session above.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
  <script>
    const $ = (s) => document.querySelector(s);
    const tokenInput = $("#token-input");
    const btnConnect = $("#btn-connect");
    const statusEl = $("#status");
    const sessionBar = $("#session-bar");
    const noSessions = $("#no-sessions");
    const splash = $("#splash");
    const termContainer = $("#terminal-container");

    let ws = null;
    let seq = 0;
    let attachedId = null;
    let sessions = [];
    let pollInterval = null;

    // --- xterm ---
    const term = new window.Terminal({
      cursorBlink: true,
      fontSize: 13,
      theme: { background: "#1a1a2e", foreground: "#e0e0e0", cursor: "#e94560" },
    });
    const fitAddon = new window.FitAddon.FitAddon();
    term.loadAddon(fitAddon);
    term.open(termContainer);
    fitAddon.fit();
    term.element.style.display = "none";

    window.addEventListener("resize", () => {
      fitAddon.fit();
      if (ws && ws.readyState === 1 && attachedId) {
        sendMsg({ type: "resize", payload: { cols: term.cols, rows: term.rows } });
      }
    });

    term.onData((data) => {
      if (ws && ws.readyState === 1 && attachedId) {
        sendMsg({ type: "input", payload: { data } });
      }
    });

    // --- WS helpers ---
    function sendMsg(msg) {
      ws.send(JSON.stringify({ ...msg, seq: ++seq }));
    }

    function setStatus(text, color) {
      statusEl.textContent = text;
      statusEl.style.color = color || "#888";
    }

    // --- Connect ---
    btnConnect.addEventListener("click", () => {
      if (ws && ws.readyState <= 1) {
        ws.close();
        return;
      }
      const token = tokenInput.value.trim();
      if (!token) { tokenInput.focus(); return; }
      doConnect(token);
    });

    tokenInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") btnConnect.click();
    });

    function doConnect(token) {
      const proto = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${proto}://${location.host}?token=${encodeURIComponent(token)}`);
      ws.binaryType = "arraybuffer";
      setStatus("connecting...", "#e9a945");
      btnConnect.textContent = "Disconnect";
      btnConnect.classList.add("active");

      ws.addEventListener("open", () => {
        setStatus("connected", "#4caf50");
        listSessions();
        pollInterval = setInterval(listSessions, 3000);
      });

      ws.addEventListener("message", (evt) => {
        if (evt.data instanceof ArrayBuffer) {
          term.write(new Uint8Array(evt.data));
          return;
        }
        const msg = JSON.parse(evt.data);
        handleMessage(msg);
      });

      ws.addEventListener("close", () => {
        setStatus("disconnected", "#888");
        btnConnect.textContent = "Connect";
        btnConnect.classList.remove("active");
        ws = null;
        attachedId = null;
        sessions = [];
        renderSessions();
        if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
        splash.style.display = "";
        term.element.style.display = "none";
      });

      ws.addEventListener("error", () => {
        setStatus("error", "#e94560");
      });
    }

    // --- Message handling ---
    function handleMessage(msg) {
      switch (msg.type) {
        case "session_list":
          sessions = msg.payload.sessions;
          renderSessions();
          if (autoAttachSession && !attachedId) {
            const target = sessions.find(s => s.id === autoAttachSession || s.id.startsWith(autoAttachSession));
            if (target) {
              autoAttachSession = null;
              attachTo(target.id);
            }
          }
          break;
        case "session_created":
          listSessions();
          break;
        case "attached":
          attachedId = msg.payload.target;
          splash.style.display = "none";
          term.element.style.display = "";
          term.clear();
          fitAddon.fit();
          renderSessions();
          term.focus();
          break;
        case "detached":
          attachedId = null;
          renderSessions();
          if (msg.payload.reason === "session_exit") {
            splash.textContent = "Session exited.";
          }
          splash.style.display = "";
          term.element.style.display = "none";
          listSessions();
          break;
        case "error":
          console.error("Server error:", msg.payload.message);
          break;
      }
    }

    // --- Sessions ---
    function listSessions() {
      if (ws && ws.readyState === 1) {
        sendMsg({ type: "list_sessions", payload: {} });
      }
    }

    function renderSessions() {
      sessionBar.innerHTML = "";
      if (sessions.length === 0) {
        sessionBar.innerHTML = `<span id="no-sessions">No sessions</span>`;
        return;
      }
      for (const s of sessions) {
        const tab = document.createElement("div");
        tab.className = "session-tab" + (s.id === attachedId ? " attached" : "");
        tab.innerHTML = `<span class="dot ${s.status === "exited" ? "exited" : ""}"></span>${s.name} <span style="color:#666;font-size:10px">${s.id.slice(0, 8)}</span>`;
        tab.addEventListener("click", () => attachTo(s.id));
        sessionBar.appendChild(tab);
      }
    }

    function attachTo(id) {
      if (!ws || ws.readyState !== 1) return;
      if (attachedId) {
        sendMsg({ type: "detach", payload: {} });
      }
      fitAddon.fit();
      sendMsg({ type: "attach", payload: { target: id, cols: term.cols, rows: term.rows } });
    }

    // Pre-fill token from URL hash: #TOKEN or #TOKEN/SESSION_ID
    let autoAttachSession = null;
    if (location.hash.length > 1) {
      const hashValue = decodeURIComponent(location.hash.slice(1));
      const slashIdx = hashValue.indexOf("/");
      if (slashIdx !== -1) {
        tokenInput.value = hashValue.slice(0, slashIdx);
        autoAttachSession = hashValue.slice(slashIdx + 1);
      } else {
        tokenInput.value = hashValue;
      }
    }
  </script>
</body>
</html>
